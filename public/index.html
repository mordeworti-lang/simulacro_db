<!DOCTYPE html>
<html lang="es" dir="ltr">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <meta name="description" content="SaludPlus — Sistema de gestión clínica"/>
  <title>SaludPlus</title>

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            display: ['Syne', 'sans-serif'],
            body:    ['Instrument Sans', 'sans-serif'],
          },
          colors: { brand: '#1849F4' },
          keyframes: {
            slideIn: { from: { opacity:'0', transform:'translateX(14px)' },  to: { opacity:'1', transform:'none' } },
            fadeIn:  { from: { opacity:'0', transform:'translateY(-5px)' }, to: { opacity:'1', transform:'none' } },
            pageIn:  { from: { opacity:'0', transform:'translateY(8px)' },  to: { opacity:'1', transform:'none' } },
            modalIn: { from: { opacity:'0', transform:'scale(.96) translateY(8px)' }, to: { opacity:'1', transform:'none' } },
            spin:    { to:   { transform:'rotate(360deg)' } },
            toastIn: { from: { opacity:'0', transform:'translateY(8px) scale(.97)' }, to: { opacity:'1', transform:'none' } },
          },
          animation: {
            slideIn: 'slideIn .28s cubic-bezier(.4,0,.2,1) both',
            fadeIn:  'fadeIn .2s cubic-bezier(.4,0,.2,1)',
            pageIn:  'pageIn .2s cubic-bezier(.4,0,.2,1) both',
            modalIn: 'modalIn .25s cubic-bezier(.4,0,.2,1) both',
            spin:    'spin .65s linear infinite',
            toastIn: 'toastIn .22s cubic-bezier(.4,0,.2,1) both',
          },
        }
      }
    }
  </script>

  <!-- Fuentes -->
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;500;600;700&family=Instrument+Sans:ital,wght@0,400;0,500;0,600;1,400&display=swap" rel="stylesheet"/>

  <!-- Estilos propios -->
  <link rel="stylesheet" href="css/app.css"/>
</head>
<body class="bg-gray-50 text-gray-900 min-h-screen antialiased overflow-x-hidden">

<!-- ══════════════════════════════════════════════════════════════
     PANTALLA DE AUTENTICACIÓN
══════════════════════════════════════════════════════════════ -->
<div id="auth" class="min-h-screen grid grid-cols-1 md:grid-cols-2">

  <!-- Panel izquierdo decorativo -->
  <div class="hidden md:flex bg-gray-950 flex-col justify-between p-12 relative overflow-hidden">
    <div class="absolute inset-0 pointer-events-none"
         style="background: radial-gradient(ellipse 60% 50% at 20% 20%,rgba(24,73,244,.35),transparent 60%),radial-gradient(ellipse 40% 40% at 80% 80%,rgba(74,111,245,.2),transparent 60%)"></div>
    <div class="absolute inset-0 pointer-events-none"
         style="background-image:linear-gradient(rgba(255,255,255,.03) 1px,transparent 1px),linear-gradient(90deg,rgba(255,255,255,.03) 1px,transparent 1px);background-size:48px 48px"></div>

    <div class="flex items-center gap-3 relative z-10">
      <div class="w-10 h-10 bg-white rounded-xl grid place-items-center">
        <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="#1849F4" stroke-width="2.5"><path d="M12 2l2 7h7l-5.5 4 2 7L12 16l-5.5 4 2-7L3 9h7z"/></svg>
      </div>
      <span class="font-display font-bold text-white text-lg tracking-tight">SaludPlus</span>
    </div>

    <div class="relative z-10">
      <h2 class="font-display font-bold text-white text-4xl leading-tight tracking-tight mb-4">Gestión clínica<br/>sin fricciones</h2>
      <p class="text-white/40 text-sm leading-relaxed max-w-xs">Pacientes, médicos y reportes financieros desde un solo lugar. Simple, rápido, confiable.</p>
    </div>

    <div class="flex gap-7 relative z-10">
      <div>
        <div id="st-d" class="font-display font-bold text-white text-3xl tracking-tight leading-none">—</div>
        <div class="text-white/35 text-xs uppercase tracking-widest mt-1">Médicos</div>
      </div>
      <div>
        <div id="st-a" class="font-display font-bold text-white text-3xl tracking-tight leading-none">—</div>
        <div class="text-white/35 text-xs uppercase tracking-widest mt-1">Consultas</div>
      </div>
    </div>
  </div>

  <!-- Panel derecho con formularios -->
  <div class="bg-white flex items-center justify-center p-8 md:p-12 min-h-screen md:min-h-0">
    <div class="w-full max-w-sm">

      <!-- FORMULARIO LOGIN -->
      <section id="fl" class="animate-slideIn" aria-label="Inicio de sesión">
        <h1 class="font-display font-bold text-2xl tracking-tight mb-1">Bienvenido</h1>
        <p class="text-gray-500 text-sm mb-6 leading-relaxed">Ingresa tu correo y contraseña para continuar</p>

        <div id="la" class="hidden items-start gap-2 p-3 rounded-xl bg-red-50 border border-red-200 text-red-700 text-sm mb-4 animate-fadeIn" role="alert">
          <svg class="w-4 h-4 flex-shrink-0 mt-0.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>
          <span id="la-m"></span>
        </div>

        <div class="mb-4">
          <label class="block text-xs font-bold text-gray-500 uppercase tracking-widest mb-1.5" for="le">Correo electrónico</label>
          <input id="le" type="email" autocomplete="email" placeholder="tu@email.com" required
                 class="w-full px-3.5 py-2.5 border-2 border-gray-200 rounded-xl text-sm bg-white text-gray-900 outline-none transition-all placeholder-gray-400 focus:border-brand focus:shadow-[0_0_0_3.5px_rgba(24,73,244,.12)] hover:border-gray-400"/>
        </div>
        <div class="mb-5">
          <label class="block text-xs font-bold text-gray-500 uppercase tracking-widest mb-1.5" for="lp">Contraseña</label>
          <input id="lp" type="password" autocomplete="current-password" placeholder="••••••••" required
                 class="w-full px-3.5 py-2.5 border-2 border-gray-200 rounded-xl text-sm bg-white text-gray-900 outline-none transition-all placeholder-gray-400 focus:border-brand focus:shadow-[0_0_0_3.5px_rgba(24,73,244,.12)] hover:border-gray-400"/>
        </div>

        <button id="lb" type="button" onclick="doLogin()"
                class="w-full flex items-center justify-center gap-2 py-3 px-5 bg-gray-950 text-white font-semibold text-sm rounded-xl transition-all hover:-translate-y-px hover:shadow-lg hover:bg-gray-800 disabled:opacity-50 disabled:pointer-events-none mt-1">
          <span id="lb-sp" class="hidden w-3.5 h-3.5 border-2 border-white/30 border-t-white rounded-full animate-spin"></span>
          <span id="lb-t">Iniciar sesión</span>
        </button>

        <p class="text-center text-sm text-gray-500 mt-5">
          ¿No tienes cuenta?
          <button type="button" onclick="sw('r')" class="text-brand font-semibold hover:underline">Regístrate</button>
        </p>
      </section>

      <!-- FORMULARIO REGISTRO -->
      <section id="fr" class="hidden animate-slideIn" aria-label="Registro">
        <h1 class="font-display font-bold text-2xl tracking-tight mb-1">Crear cuenta</h1>
        <p class="text-gray-500 text-sm mb-6 leading-relaxed">Completa los datos para registrarte</p>

        <div id="ra" class="hidden items-start gap-2 p-3 rounded-xl bg-red-50 border border-red-200 text-red-700 text-sm mb-4 animate-fadeIn" role="alert">
          <svg class="w-4 h-4 flex-shrink-0 mt-0.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>
          <span id="ra-m"></span>
        </div>

        <div class="mb-4">
          <label class="block text-xs font-bold text-gray-500 uppercase tracking-widest mb-1.5" for="rn">Nombre completo</label>
          <input id="rn" type="text" autocomplete="name" placeholder="María García" required minlength="2"
                 class="w-full px-3.5 py-2.5 border-2 border-gray-200 rounded-xl text-sm bg-white text-gray-900 outline-none transition-all placeholder-gray-400 focus:border-brand focus:shadow-[0_0_0_3.5px_rgba(24,73,244,.12)] hover:border-gray-400"/>
        </div>
        <div class="mb-4">
          <label class="block text-xs font-bold text-gray-500 uppercase tracking-widest mb-1.5" for="re">Correo electrónico</label>
          <input id="re" type="email" autocomplete="email" placeholder="tu@email.com" required
                 class="w-full px-3.5 py-2.5 border-2 border-gray-200 rounded-xl text-sm bg-white text-gray-900 outline-none transition-all placeholder-gray-400 focus:border-brand focus:shadow-[0_0_0_3.5px_rgba(24,73,244,.12)] hover:border-gray-400"/>
        </div>
        <div class="mb-4">
          <label class="block text-xs font-bold text-gray-500 uppercase tracking-widest mb-1.5" for="rp">Contraseña</label>
          <input id="rp" type="password" autocomplete="new-password" placeholder="••••••••" required minlength="6"
                 class="w-full px-3.5 py-2.5 border-2 border-gray-200 rounded-xl text-sm bg-white text-gray-900 outline-none transition-all placeholder-gray-400 focus:border-brand focus:shadow-[0_0_0_3.5px_rgba(24,73,244,.12)] hover:border-gray-400"/>
        </div>

        <!-- Selector de rol -->
        <div class="mb-4">
          <span class="block text-xs font-bold text-gray-500 uppercase tracking-widest mb-2">Rol</span>
          <div class="grid grid-cols-3 gap-2" role="radiogroup" aria-label="Selecciona tu rol">
            <button type="button" data-role="patient" onclick="pickRole(this)"
                    class="ro border-2 border-brand bg-blue-50 rounded-xl px-3 py-2.5 text-center transition-all cursor-pointer" aria-checked="true">
              <svg class="w-5 h-5 mx-auto mb-1 text-brand" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/></svg>
              <span class="text-xs font-semibold text-brand">Paciente</span>
            </button>
            <button type="button" data-role="doctor" onclick="pickRole(this)"
                    class="ro border-2 border-gray-200 rounded-xl px-3 py-2.5 text-center transition-all cursor-pointer" aria-checked="false">
              <svg class="w-5 h-5 mx-auto mb-1 text-gray-500" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87M16 3.13a4 4 0 0 1 0 7.75"/></svg>
              <span class="text-xs font-semibold text-gray-500">Médico</span>
            </button>
            <button type="button" data-role="admin" onclick="pickRole(this)"
                    class="ro border-2 border-gray-200 rounded-xl px-3 py-2.5 text-center transition-all cursor-pointer" aria-checked="false">
              <svg class="w-5 h-5 mx-auto mb-1 text-gray-500" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>
              <span class="text-xs font-semibold text-gray-500">Admin</span>
            </button>
          </div>
        </div>

        <!-- Campos extra: médico -->
        <div id="reg-doctor-fields" class="hidden mb-4">
          <label class="block text-xs font-bold text-gray-500 uppercase tracking-widest mb-1.5" for="r-specialty">Especialidad *</label>
          <input id="r-specialty" type="text" placeholder="Ej: Cardiology, Pediatrics…" autocomplete="off"
                 class="w-full px-3.5 py-2.5 border-2 border-gray-200 rounded-xl text-sm bg-white text-gray-900 outline-none transition-all placeholder-gray-400 focus:border-brand focus:shadow-[0_0_0_3.5px_rgba(24,73,244,.12)] hover:border-gray-400"/>
        </div>

        <!-- Campos extra: paciente -->
        <div id="reg-patient-fields" class="hidden mb-4">
          <div class="grid grid-cols-2 gap-3">
            <div>
              <label class="block text-xs font-bold text-gray-500 uppercase tracking-widest mb-1.5" for="r-phone">Teléfono</label>
              <input id="r-phone" type="tel" placeholder="Ej: 3001234567" autocomplete="tel"
                     class="w-full px-3.5 py-2.5 border-2 border-gray-200 rounded-xl text-sm bg-white text-gray-900 outline-none transition-all placeholder-gray-400 focus:border-brand focus:shadow-[0_0_0_3.5px_rgba(24,73,244,.12)] hover:border-gray-400"/>
            </div>
            <div>
              <label class="block text-xs font-bold text-gray-500 uppercase tracking-widest mb-1.5" for="r-address">Dirección</label>
              <input id="r-address" type="text" placeholder="Ej: Cra 12 #45-67" autocomplete="street-address"
                     class="w-full px-3.5 py-2.5 border-2 border-gray-200 rounded-xl text-sm bg-white text-gray-900 outline-none transition-all placeholder-gray-400 focus:border-brand focus:shadow-[0_0_0_3.5px_rgba(24,73,244,.12)] hover:border-gray-400"/>
            </div>
          </div>
        </div>

        <button id="rb" type="button" onclick="doRegister()"
                class="w-full flex items-center justify-center gap-2 py-3 px-5 bg-gray-950 text-white font-semibold text-sm rounded-xl transition-all hover:-translate-y-px hover:shadow-lg hover:bg-gray-800 disabled:opacity-50 disabled:pointer-events-none mt-1">
          <span id="rb-sp" class="hidden w-3.5 h-3.5 border-2 border-white/30 border-t-white rounded-full animate-spin"></span>
          <span id="rb-t">Crear cuenta</span>
        </button>

        <p class="text-center text-sm text-gray-500 mt-5">
          ¿Ya tienes cuenta?
          <button type="button" onclick="sw('l')" class="text-brand font-semibold hover:underline">Inicia sesión</button>
        </p>
      </section>

    </div>
  </div>
</div>


<!-- ══════════════════════════════════════════════════════════════
     APP PRINCIPAL (oculta hasta hacer login)
══════════════════════════════════════════════════════════════ -->
<div id="app" class="hidden min-h-screen">

  <!-- Topbar móvil -->
  <header id="topbar" class="md:hidden fixed top-0 left-0 right-0 h-14 bg-white border-b border-gray-100 flex items-center px-4 gap-3 z-50">
    <button id="tb-btn" onclick="togSB()" aria-label="Abrir menú" class="text-gray-500 p-1 rounded-lg">
      <svg class="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="18" x2="21" y2="18"/></svg>
    </button>
    <span id="tb-title" class="font-display font-bold text-base tracking-tight">SaludPlus</span>
  </header>

  <!-- Overlay sidebar móvil -->
  <div id="sb-ov" class="hidden fixed inset-0 bg-black/50 z-40 backdrop-blur-sm md:hidden" onclick="clSB()"></div>

  <!-- Sidebar -->
  <nav id="sb" class="sb-nav fixed inset-y-0 left-0 w-[232px] bg-gray-950 flex flex-col z-50 transition-transform -translate-x-full md:translate-x-0" aria-label="Navegación">
    <div class="px-4 py-5 border-b border-white/[0.07] flex items-center gap-3">
      <div class="w-8 h-8 bg-brand rounded-[9px] grid place-items-center flex-shrink-0">
        <svg class="w-4 h-4 fill-white" viewBox="0 0 24 24"><path d="M12 2l2 7h7l-5.5 4 2 7L12 16l-5.5 4 2-7L3 9h7z"/></svg>
      </div>
      <span class="font-display font-bold text-white text-base tracking-tight">SaludPlus</span>
    </div>
    <div class="flex-1 px-2.5 py-3.5 overflow-y-auto sb-nav" id="sb-links">
      <!-- Ítems inyectados por buildNav() -->
    </div>
    <div class="px-2.5 py-3 border-t border-white/[0.07]">
      <div class="flex items-center gap-2.5 px-2.5 py-2 rounded-lg">
        <div id="u-av" class="w-8 h-8 rounded-full bg-brand text-white font-display text-sm font-bold grid place-items-center flex-shrink-0">U</div>
        <div class="flex-1 min-w-0">
          <div id="u-name" class="text-sm font-semibold text-white truncate">—</div>
          <div id="u-role" class="text-xs text-white/30 capitalize">—</div>
        </div>
        <button onclick="doLogout()" aria-label="Cerrar sesión" title="Cerrar sesión"
                class="text-white/25 p-1.5 rounded-md hover:text-red-400 hover:bg-red-500/10 transition-all">
          <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
        </button>
      </div>
    </div>
  </nav>

  <!-- Contenido principal -->
  <div id="main" class="md:ml-[232px] flex-1 min-w-0 flex flex-col pt-14 md:pt-0">

    <!-- ════════════════ PÁGINAS ADMIN ════════════════ -->

    <!-- Admin: Lista de médicos -->
    <main id="pg-doctors" class="page hidden flex-col flex-1 animate-pageIn">
      <div class="px-6 md:px-9 pt-7 pb-5 flex items-end justify-between flex-wrap gap-3">
        <div>
          <h1 class="font-display font-bold text-2xl tracking-tight leading-tight">Médicos</h1>
          <p class="text-gray-500 text-sm mt-0.5">Directorio de especialistas</p>
        </div>
      </div>
      <div class="px-6 md:px-9 pb-10 flex-1">
        <div class="bg-white border border-gray-100 rounded-2xl shadow-sm overflow-hidden">
          <div class="px-5 py-4 border-b border-gray-100 flex items-center justify-between gap-3 flex-wrap">
            <span id="dc" class="font-display font-bold text-sm tracking-tight" aria-live="polite">—</span>
            <div class="flex gap-2 items-center flex-wrap">
              <div class="relative flex items-center">
                <svg class="absolute left-2.5 w-4 h-4 text-gray-400 pointer-events-none" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
                <input id="ds" type="search" placeholder="Buscar…" aria-label="Buscar médico" oninput="filterDoc()"
                       class="pl-8 pr-3 py-1.5 border-2 border-gray-200 rounded-xl text-sm bg-white text-gray-900 outline-none w-48 transition-all placeholder-gray-400 focus:border-brand focus:shadow-[0_0_0_3px_rgba(24,73,244,.1)] focus:w-56"/>
              </div>
              <select id="sf" aria-label="Filtrar especialidad" onchange="filterDoc()"
                      class="px-2.5 py-1.5 border-2 border-gray-200 rounded-xl text-sm bg-white text-gray-900 outline-none cursor-pointer transition-colors focus:border-brand">
                <option value="">Todas las especialidades</option>
              </select>
            </div>
          </div>
          <div id="dt" class="overflow-x-auto" aria-live="polite"></div>
        </div>
      </div>
    </main>

    <!-- Admin: Historial de paciente -->
    <main id="pg-history" class="page hidden flex-col flex-1 animate-pageIn">
      <div class="px-6 md:px-9 pt-7 pb-5 flex items-end justify-between gap-3 flex-wrap">
        <div>
          <h1 class="font-display font-bold text-2xl tracking-tight leading-tight">Historial</h1>
          <p class="text-gray-500 text-sm mt-0.5">Historial clínico por correo</p>
        </div>
        <button type="button" onclick="openNewAppt()"
                class="flex items-center gap-2 px-4 py-2 bg-gray-950 text-white text-sm font-semibold rounded-xl hover:bg-gray-800 transition-all hover:-translate-y-px hover:shadow-md">
          <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
          Nueva Cita
        </button>
      </div>
      <div class="px-6 md:px-9 pb-10 flex-1">
        <div class="flex gap-2 mb-5" role="search">
          <input id="he" type="email" placeholder="paciente@email.com" aria-label="Email del paciente"
                 onkeydown="if(event.key==='Enter')loadHist()"
                 class="flex-1 px-4 py-2.5 border-2 border-gray-200 rounded-2xl text-sm bg-white text-gray-900 outline-none transition-all placeholder-gray-400 focus:border-brand focus:shadow-[0_0_0_3px_rgba(24,73,244,.1)]"/>
          <button type="button" onclick="loadHist()" class="px-4 py-2 bg-brand text-white text-sm font-semibold rounded-xl hover:bg-blue-700 transition-colors">Buscar</button>
        </div>
        <div id="hr" aria-live="polite"></div>
      </div>
    </main>

    <!-- Admin: Recaudación -->
    <main id="pg-revenue" class="page hidden flex-col flex-1 animate-pageIn">
      <div class="px-6 md:px-9 pt-7 pb-5">
        <h1 class="font-display font-bold text-2xl tracking-tight leading-tight">Recaudación</h1>
        <p class="text-gray-500 text-sm mt-0.5">Ingresos por seguro médico</p>
      </div>
      <div class="px-6 md:px-9 pb-10 flex-1">
        <div class="flex gap-2 items-end mb-5 flex-wrap">
          <div>
            <label class="block text-xs font-bold text-gray-500 uppercase tracking-widest mb-1.5" for="rs">Desde</label>
            <input type="date" id="rs" class="px-3 py-2 border-2 border-gray-200 rounded-xl text-sm bg-white outline-none focus:border-brand transition-colors"/>
          </div>
          <div>
            <label class="block text-xs font-bold text-gray-500 uppercase tracking-widest mb-1.5" for="re2">Hasta</label>
            <input type="date" id="re2" class="px-3 py-2 border-2 border-gray-200 rounded-xl text-sm bg-white outline-none focus:border-brand transition-colors"/>
          </div>
          <button type="button" onclick="loadRev()" class="px-4 py-2 bg-brand text-white text-sm font-semibold rounded-xl hover:bg-blue-700 transition-colors">Aplicar</button>
          <button type="button" onclick="clRev()" class="px-4 py-2 bg-white text-gray-700 text-sm font-semibold rounded-xl border-2 border-gray-200 hover:bg-gray-50 hover:border-gray-400 transition-all">Limpiar</button>
        </div>
        <div id="rr" aria-live="polite"></div>
      </div>
    </main>

    <!-- ════════════════ PÁGINAS DOCTOR ════════════════ -->

    <!-- Doctor: Mis citas -->
    <main id="pg-doc-appts" class="page hidden flex-col flex-1 animate-pageIn">
      <div class="px-6 md:px-9 pt-7 pb-5 flex items-end justify-between flex-wrap gap-3">
        <div>
          <h1 class="font-display font-bold text-2xl tracking-tight leading-tight">Mis Citas</h1>
          <p class="text-gray-500 text-sm mt-0.5">Agenda del día y citas recientes</p>
        </div>
        <div class="flex gap-2">
          <button type="button" onclick="loadDocAppts('today')" id="dab-today"
                  class="px-3 py-1.5 text-xs font-semibold rounded-xl border-2 border-brand bg-blue-50 text-brand hover:bg-brand hover:text-white transition-all">Hoy</button>
          <button type="button" onclick="loadDocAppts('all')" id="dab-all"
                  class="px-3 py-1.5 text-xs font-semibold rounded-xl border-2 border-gray-200 text-gray-600 hover:border-gray-400 transition-all">Todas</button>
        </div>
      </div>
      <div class="px-6 md:px-9 pb-10 flex-1">
        <div id="doc-appts-list" aria-live="polite"></div>
      </div>
    </main>

    <!-- Doctor: Búsqueda de pacientes -->
    <main id="pg-doc-patients" class="page hidden flex-col flex-1 animate-pageIn">
      <div class="px-6 md:px-9 pt-7 pb-5">
        <h1 class="font-display font-bold text-2xl tracking-tight leading-tight">Pacientes</h1>
        <p class="text-gray-500 text-sm mt-0.5">Busca un paciente y ve su historial</p>
      </div>
      <div class="px-6 md:px-9 pb-10 flex-1">
        <div class="flex gap-2 mb-5" role="search">
          <div class="relative flex-1">
            <svg class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-400 pointer-events-none" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
            <input id="doc-pat-q" type="text" placeholder="Nombre o email del paciente…"
                   oninput="searchPatients()" onkeydown="if(event.key==='Enter')searchPatients()"
                   class="w-full pl-9 pr-4 py-2.5 border-2 border-gray-200 rounded-2xl text-sm bg-white text-gray-900 outline-none transition-all placeholder-gray-400 focus:border-brand focus:shadow-[0_0_0_3px_rgba(24,73,244,.1)]"/>
          </div>
          <button type="button" onclick="searchPatients()" class="px-4 py-2 bg-brand text-white text-sm font-semibold rounded-xl hover:bg-blue-700 transition-colors">Buscar</button>
        </div>
        <div id="doc-pat-results" aria-live="polite"></div>
        <div id="doc-pat-history" class="mt-5"></div>
      </div>
    </main>

    <!-- ════════════════ PÁGINAS PACIENTE ════════════════ -->

    <!-- Paciente: Mis citas -->
    <main id="pg-pat-appts" class="page hidden flex-col flex-1 animate-pageIn">
      <div class="px-6 md:px-9 pt-7 pb-5 flex items-end justify-between flex-wrap gap-3">
        <div>
          <h1 class="font-display font-bold text-2xl tracking-tight leading-tight">Mis Citas</h1>
          <p class="text-gray-500 text-sm mt-0.5">Tu historial de consultas</p>
        </div>
        <button type="button" onclick="openNewAppt()"
                class="flex items-center gap-2 px-4 py-2 bg-gray-950 text-white text-sm font-semibold rounded-xl hover:bg-gray-800 transition-all hover:-translate-y-px hover:shadow-md">
          <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
          Pedir cita
        </button>
      </div>
      <div class="px-6 md:px-9 pb-10 flex-1">
        <div id="pat-appts-list" aria-live="polite"></div>
      </div>
    </main>

    <!-- Paciente: Mi historial -->
    <main id="pg-pat-history" class="page hidden flex-col flex-1 animate-pageIn">
      <div class="px-6 md:px-9 pt-7 pb-5">
        <h1 class="font-display font-bold text-2xl tracking-tight leading-tight">Mi Historial</h1>
        <p class="text-gray-500 text-sm mt-0.5">Diagnósticos y tratamientos</p>
      </div>
      <div class="px-6 md:px-9 pb-10 flex-1">
        <div id="pat-history-content" aria-live="polite"></div>
      </div>
    </main>

  </div>
</div>


<!-- ══════════════════════════════════════════════════════════════
     MODAL — EDITAR MÉDICO
══════════════════════════════════════════════════════════════ -->
<div id="dm" class="fixed inset-0 bg-black/45 z-[500] hidden items-center justify-center backdrop-blur-sm p-4"
     role="dialog" aria-modal="true" aria-labelledby="dm-t">
  <div class="bg-white rounded-[28px] w-full max-w-md shadow-2xl animate-modalIn max-h-[90vh] overflow-y-auto">
    <div class="px-6 py-5 flex items-center justify-between border-b border-gray-100 sticky top-0 bg-white z-10">
      <span id="dm-t" class="font-display font-bold text-base tracking-tight">Editar médico</span>
      <button onclick="clMd('dm')" aria-label="Cerrar" class="w-7 h-7 bg-gray-100 rounded-full grid place-items-center text-gray-500 hover:bg-gray-200 transition-all">✕</button>
    </div>
    <div class="px-6 py-5 flex flex-col gap-4">
      <div id="ea" class="hidden items-start gap-2 p-3 rounded-xl bg-red-50 border border-red-200 text-red-700 text-sm animate-fadeIn" role="alert">
        <svg class="w-4 h-4 flex-shrink-0 mt-0.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>
        <span id="ea-m"></span>
      </div>
      <div>
        <label class="block text-xs font-bold text-gray-500 uppercase tracking-widest mb-1.5" for="en">Nombre</label>
        <input id="en" type="text" class="w-full px-3.5 py-2.5 border-2 border-gray-200 rounded-xl text-sm bg-white outline-none transition-all focus:border-brand focus:shadow-[0_0_0_3.5px_rgba(24,73,244,.12)]"/>
      </div>
      <div>
        <label class="block text-xs font-bold text-gray-500 uppercase tracking-widest mb-1.5" for="ee">Email</label>
        <input id="ee" type="email" class="w-full px-3.5 py-2.5 border-2 border-gray-200 rounded-xl text-sm bg-white outline-none transition-all focus:border-brand focus:shadow-[0_0_0_3.5px_rgba(24,73,244,.12)]"/>
      </div>
      <div>
        <label class="block text-xs font-bold text-gray-500 uppercase tracking-widest mb-1.5" for="es">Especialidad</label>
        <input id="es" type="text" class="w-full px-3.5 py-2.5 border-2 border-gray-200 rounded-xl text-sm bg-white outline-none transition-all focus:border-brand focus:shadow-[0_0_0_3.5px_rgba(24,73,244,.12)]"/>
      </div>
      <button id="eb" type="button"
              class="w-full flex items-center justify-center gap-2 py-3 px-5 bg-gray-950 text-white font-semibold text-sm rounded-xl transition-all hover:-translate-y-px hover:shadow-lg hover:bg-gray-800 disabled:opacity-50 disabled:pointer-events-none mt-1">
        <span id="eb-sp" class="hidden w-3.5 h-3.5 border-2 border-white/30 border-t-white rounded-full animate-spin"></span>
        <span id="eb-t">Guardar cambios</span>
      </button>
    </div>
  </div>
</div>


<!-- ══════════════════════════════════════════════════════════════
     MODAL — NUEVA CITA
     (treatmentCode eliminado → el backend lo genera; fecha+hora)
══════════════════════════════════════════════════════════════ -->
<div id="new-appt-modal" class="fixed inset-0 bg-gray-950/45 backdrop-blur-sm z-50 hidden items-center justify-center p-4"
     role="dialog" aria-modal="true" aria-labelledby="na-title">
  <div class="bg-white rounded-3xl w-full max-w-lg shadow-2xl animate-modalIn max-h-[90vh] overflow-y-auto">
    <div class="sticky top-0 bg-white px-6 py-5 border-b border-gray-100 flex items-center justify-between rounded-t-3xl z-10">
      <span id="na-title" class="font-display font-bold tracking-tight">Nueva Cita</span>
      <button onclick="clMd('new-appt-modal')" class="w-7 h-7 rounded-full bg-gray-100 hover:bg-gray-200 flex items-center justify-center text-gray-500 transition-colors" aria-label="Cerrar">✕</button>
    </div>
    <div class="px-6 py-5">
      <div id="na-alert" class="hidden items-start gap-2 p-3 rounded-xl bg-red-50 border border-red-200 text-red-700 text-sm mb-4 animate-fadeIn" role="alert">
        <svg class="w-4 h-4 flex-shrink-0 mt-0.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>
        <span id="na-alert-m"></span>
      </div>

      <div id="na-loading" class="flex items-center gap-3 py-6 text-gray-400 text-sm">
        <div class="w-5 h-5 border-2 border-gray-200 border-t-brand rounded-full animate-spin flex-shrink-0"></div>
        Cargando datos del formulario…
      </div>

      <div id="na-form" class="hidden flex-col gap-4">
        <div>
          <label class="block text-xs font-bold text-gray-500 uppercase tracking-widest mb-1.5" for="na-patient">Paciente *</label>
          <select id="na-patient" class="w-full px-3.5 py-2.5 border-2 border-gray-200 rounded-xl text-sm bg-white text-gray-900 outline-none transition-all focus:border-brand focus:shadow-[0_0_0_3.5px_rgba(24,73,244,.12)]">
            <option value="">— Selecciona un paciente —</option>
          </select>
        </div>
        <div>
          <label class="block text-xs font-bold text-gray-500 uppercase tracking-widest mb-1.5" for="na-doctor">Médico *</label>
          <select id="na-doctor" class="w-full px-3.5 py-2.5 border-2 border-gray-200 rounded-xl text-sm bg-white text-gray-900 outline-none transition-all focus:border-brand focus:shadow-[0_0_0_3.5px_rgba(24,73,244,.12)]">
            <option value="">— Selecciona un médico —</option>
          </select>
        </div>
        <div>
          <label class="block text-xs font-bold text-gray-500 uppercase tracking-widest mb-1.5" for="na-datetime">Fecha y hora de la cita *</label>
          <input id="na-datetime" type="datetime-local"
                 class="w-full px-3.5 py-2.5 border-2 border-gray-200 rounded-xl text-sm bg-white text-gray-900 outline-none transition-all focus:border-brand focus:shadow-[0_0_0_3.5px_rgba(24,73,244,.12)]"/>
          <p class="text-xs text-gray-400 mt-1">Cada cita ocupa un bloque de 30 minutos.</p>
        </div>
        <div>
          <label class="block text-xs font-bold text-gray-500 uppercase tracking-widest mb-1.5" for="na-insurance">Seguro médico <span class="normal-case font-normal text-gray-400 tracking-normal">(opcional)</span></label>
          <select id="na-insurance" class="w-full px-3.5 py-2.5 border-2 border-gray-200 rounded-xl text-sm bg-white text-gray-900 outline-none transition-all focus:border-brand focus:shadow-[0_0_0_3.5px_rgba(24,73,244,.12)]">
            <option value="">— Sin seguro —</option>
          </select>
        </div>
        <div>
          <label class="block text-xs font-bold text-gray-500 uppercase tracking-widest mb-1.5" for="na-tdesc">Descripción del tratamiento *</label>
          <input id="na-tdesc" type="text" placeholder="Ej: Consulta cardiológica de control"
                 class="w-full px-3.5 py-2.5 border-2 border-gray-200 rounded-xl text-sm bg-white text-gray-900 outline-none transition-all focus:border-brand placeholder-gray-400 focus:shadow-[0_0_0_3.5px_rgba(24,73,244,.12)]"/>
        </div>
        <div class="grid grid-cols-2 gap-3">
          <div>
            <label class="block text-xs font-bold text-gray-500 uppercase tracking-widest mb-1.5" for="na-cost">Costo tratamiento</label>
            <input id="na-cost" type="number" min="0" placeholder="200000"
                   class="w-full px-3.5 py-2.5 border-2 border-gray-200 rounded-xl text-sm bg-white text-gray-900 outline-none transition-all focus:border-brand placeholder-gray-400 focus:shadow-[0_0_0_3.5px_rgba(24,73,244,.12)]"/>
          </div>
          <div>
            <label class="block text-xs font-bold text-gray-500 uppercase tracking-widest mb-1.5" for="na-paid">Monto pagado (copago)</label>
            <input id="na-paid" type="number" min="0" placeholder="80000"
                   class="w-full px-3.5 py-2.5 border-2 border-gray-200 rounded-xl text-sm bg-white text-gray-900 outline-none transition-all focus:border-brand placeholder-gray-400 focus:shadow-[0_0_0_3.5px_rgba(24,73,244,.12)]"/>
          </div>
        </div>
        <button id="na-btn" type="button" onclick="submitNewAppt()"
                class="w-full flex items-center justify-center gap-2 py-3 px-5 bg-gray-950 text-white font-semibold text-sm rounded-xl transition-all hover:-translate-y-px hover:shadow-lg hover:bg-gray-800 disabled:opacity-50 disabled:pointer-events-none mt-1">
          <span id="na-sp" class="hidden w-3.5 h-3.5 border-2 border-white/30 border-t-white rounded-full animate-spin"></span>
          <span id="na-t">Crear cita</span>
        </button>
      </div>
    </div>
  </div>
</div>


<!-- ══════════════════════════════════════════════════════════════
     MODAL — DIAGNÓSTICO / EVENTO CLÍNICO (solo doctor)
══════════════════════════════════════════════════════════════ -->
<div id="diag-modal" class="fixed inset-0 bg-gray-950/45 backdrop-blur-sm z-50 hidden items-center justify-center p-4"
     role="dialog" aria-modal="true" aria-labelledby="dg-title">
  <div class="bg-white rounded-3xl w-full max-w-lg shadow-2xl animate-modalIn max-h-[90vh] overflow-y-auto">
    <div class="sticky top-0 bg-white px-6 py-5 border-b border-gray-100 flex items-center justify-between rounded-t-3xl z-10">
      <div>
        <span id="dg-title" class="font-display font-bold tracking-tight block">Agregar diagnóstico</span>
        <span id="dg-subtitle" class="text-xs text-gray-400 mt-0.5 block"></span>
      </div>
      <button onclick="clMd('diag-modal')" class="w-7 h-7 rounded-full bg-gray-100 hover:bg-gray-200 flex items-center justify-center text-gray-500 transition-colors" aria-label="Cerrar">✕</button>
    </div>
    <div class="px-6 py-5 flex flex-col gap-4">
      <div id="dg-alert" class="hidden items-start gap-2 p-3 rounded-xl bg-red-50 border border-red-200 text-red-700 text-sm animate-fadeIn" role="alert">
        <svg class="w-4 h-4 flex-shrink-0 mt-0.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>
        <span id="dg-alert-m"></span>
      </div>
      <div>
        <label class="block text-xs font-bold text-gray-500 uppercase tracking-widest mb-1.5" for="dg-appt">Cita relacionada <span class="normal-case font-normal text-gray-400 tracking-normal">(opcional)</span></label>
        <select id="dg-appt" class="w-full px-3.5 py-2.5 border-2 border-gray-200 rounded-xl text-sm bg-white text-gray-900 outline-none transition-all focus:border-brand focus:shadow-[0_0_0_3.5px_rgba(24,73,244,.12)]">
          <option value="">— Sin cita específica —</option>
        </select>
      </div>
      <div>
        <label class="block text-xs font-bold text-gray-500 uppercase tracking-widest mb-1.5" for="dg-type">Tipo de evento *</label>
        <select id="dg-type" class="w-full px-3.5 py-2.5 border-2 border-gray-200 rounded-xl text-sm bg-white text-gray-900 outline-none transition-all focus:border-brand focus:shadow-[0_0_0_3.5px_rgba(24,73,244,.12)]">
          <option value="Diagnóstico">Diagnóstico</option>
          <option value="Tratamiento">Tratamiento</option>
          <option value="Observación">Observación</option>
          <option value="Seguimiento">Seguimiento</option>
          <option value="Resultado de examen">Resultado de examen</option>
          <option value="Medicación">Medicación</option>
        </select>
      </div>
      <div>
        <label class="block text-xs font-bold text-gray-500 uppercase tracking-widest mb-1.5" for="dg-date">Fecha *</label>
        <input id="dg-date" type="date" class="w-full px-3.5 py-2.5 border-2 border-gray-200 rounded-xl text-sm bg-white text-gray-900 outline-none transition-all focus:border-brand focus:shadow-[0_0_0_3.5px_rgba(24,73,244,.12)]"/>
      </div>
      <div>
        <label class="block text-xs font-bold text-gray-500 uppercase tracking-widest mb-1.5" for="dg-title-field">Título / diagnóstico *</label>
        <input id="dg-title-field" type="text" placeholder="Ej: Hipertensión arterial leve" autocomplete="off"
               class="w-full px-3.5 py-2.5 border-2 border-gray-200 rounded-xl text-sm bg-white text-gray-900 outline-none transition-all placeholder-gray-400 focus:border-brand focus:shadow-[0_0_0_3.5px_rgba(24,73,244,.12)] hover:border-gray-400"/>
      </div>
      <div>
        <label class="block text-xs font-bold text-gray-500 uppercase tracking-widest mb-1.5" for="dg-notes">Notas / descripción *</label>
        <textarea id="dg-notes" rows="3" placeholder="Descripción detallada del diagnóstico, tratamiento o hallazgo…"
                  class="w-full px-3.5 py-2.5 border-2 border-gray-200 rounded-xl text-sm bg-white text-gray-900 outline-none transition-all placeholder-gray-400 focus:border-brand focus:shadow-[0_0_0_3.5px_rgba(24,73,244,.12)] hover:border-gray-400 resize-none"></textarea>
      </div>
      <div>
        <label class="block text-xs font-bold text-gray-500 uppercase tracking-widest mb-1.5" for="dg-prescription">Prescripción / indicaciones <span class="normal-case font-normal text-gray-400 tracking-normal">(opcional)</span></label>
        <input id="dg-prescription" type="text" placeholder="Ej: Enalapril 10mg 1 vez al día por 30 días" autocomplete="off"
               class="w-full px-3.5 py-2.5 border-2 border-gray-200 rounded-xl text-sm bg-white text-gray-900 outline-none transition-all placeholder-gray-400 focus:border-brand focus:shadow-[0_0_0_3.5px_rgba(24,73,244,.12)] hover:border-gray-400"/>
      </div>
      <button id="dg-btn" type="button" onclick="submitDiagnosis()"
              class="w-full flex items-center justify-center gap-2 py-3 px-5 bg-gray-950 text-white font-semibold text-sm rounded-xl transition-all hover:-translate-y-px hover:shadow-lg hover:bg-gray-800 disabled:opacity-50 disabled:pointer-events-none mt-1">
        <span id="dg-btn-sp" class="hidden w-3.5 h-3.5 border-2 border-white/30 border-t-white rounded-full animate-spin"></span>
        <span id="dg-btn-t">Guardar en historial</span>
      </button>
    </div>
  </div>
</div>


<!-- ══════════════════════════════════════════════════════════════
     MODAL — ACTIVAR USUARIOS MIGRADOS (admin)
══════════════════════════════════════════════════════════════ -->
<div id="rehash-modal" class="fixed inset-0 bg-gray-950/45 backdrop-blur-sm z-50 hidden items-center justify-center p-4"
     role="dialog" aria-modal="true" aria-labelledby="rh-title">
  <div class="bg-white rounded-3xl w-full max-w-md shadow-2xl animate-modalIn overflow-y-auto max-h-[80vh]">
    <div class="sticky top-0 bg-white px-6 py-5 border-b border-gray-100 flex items-center justify-between rounded-t-3xl z-10">
      <span id="rh-title" class="font-display font-bold tracking-tight">Activar usuarios migrados</span>
      <button onclick="clMd('rehash-modal')" class="w-7 h-7 rounded-full bg-gray-100 hover:bg-gray-200 flex items-center justify-center text-gray-500 transition-colors" aria-label="Cerrar">✕</button>
    </div>
    <div class="px-6 py-5">
      <p class="text-sm text-gray-600 mb-4 leading-relaxed">
        Los usuarios importados desde el CSV tienen la contraseña
        <code class="bg-gray-100 px-1.5 py-0.5 rounded text-xs font-mono">migrated_no_password</code>
        y no pueden iniciar sesión. Esta acción les asigna la contraseña
        <code class="bg-blue-50 text-blue-700 px-1.5 py-0.5 rounded text-xs font-mono font-bold">saludplus123</code>
        para que puedan hacer login.
      </p>
      <div id="rh-result" class="hidden mb-4 p-3 bg-green-50 border border-green-200 rounded-xl text-sm text-green-700"></div>
      <button id="rh-btn" type="button" onclick="doRehash()"
              class="w-full flex items-center justify-center gap-2 py-3 px-5 bg-gray-950 text-white font-semibold text-sm rounded-xl transition-all hover:-translate-y-px hover:shadow-lg hover:bg-gray-800 disabled:opacity-50 disabled:pointer-events-none">
        <span id="rh-sp" class="hidden w-3.5 h-3.5 border-2 border-white/30 border-t-white rounded-full animate-spin"></span>
        <span id="rh-t">Activar todos los usuarios</span>
      </button>
    </div>
  </div>
</div>


<!-- ══════════════════════════════════════════════════════════════
     TOASTS
══════════════════════════════════════════════════════════════ -->
<div id="toasts" class="fixed bottom-5 right-5 z-[900] flex flex-col gap-2 pointer-events-none"
     role="region" aria-label="Notificaciones" aria-live="polite"></div>


<!-- ══════════════════════════════════════════════════════════════
     SCRIPTS — orden importante: core primero, app al final
══════════════════════════════════════════════════════════════ -->
<script src="js/core.js"></script>
<script src="js/auth.js"></script>
<script src="js/nav.js"></script>
<script src="js/admin.js"></script>
<script src="js/doctor.js"></script>
<script src="js/patient.js"></script>
<script src="js/modals.js"></script>
<script src="js/app.js"></script>

</body>
</html>
